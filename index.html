<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover" />
<title>雙計時器 · 配方 + PWA + 常亮 / Dual Timers · Recipes + PWA + Wake Lock</title>
<meta name="theme-color" content="#0b1020">
<style>
  :root {
    --bg:#0b1020; --card:#121a33; --ink:#e9eefc; --muted:#95a1c4; --accent:#6aa9ff; --warn:#ffb86b; --ok:#46d39a;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto; color:var(--ink); background:linear-gradient(180deg,#0a0f1e,#0d1326);}
  .wrap{max-width:1200px; margin:0 auto; padding:12px;}
  .title{font-weight:800; font-size:22px; letter-spacing:.3px; margin:8px 0}
  .sub{color:var(--muted); margin-bottom:10px}
  .en{display:block; font-size:12px; color:var(--muted)}
  .badge{font-size:12px; color:#0b1020; background:var(--warn); border-radius:8px; padding:2px 8px; display:inline-block}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:#0c1430; color:var(--ink); display:inline-flex; gap:8px; align-items:center}
  button{padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:#0f1a3b; color:var(--ink); cursor:pointer; font-weight:600}
  button.primary{background:linear-gradient(135deg,#4d87ff,#6aa9ff); color:#0a0f1e; border:none}
  button.warn{background:#2b1a05; border:1px solid #ffb86b; color:#ffb86b}
  input[type="number"]{width:64px; padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0c1430; color:var(--ink); font-size:18px; text-align:center}

  /* Layouts */
  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0 10px}
  .status-bar{display:flex; gap:10px; flex-wrap:wrap; margin:6px 0 10px}
  .big-status{flex:1; min-width:240px; padding:10px 12px; border-radius:12px;
    background:rgba(70,211,154,.12); border:1px solid rgba(70,211,154,.35);
    font-weight:800; font-size:22px; letter-spacing:.5px; display:flex; justify-content:space-between; align-items:center}
  .big-status .subtxt{font-size:13px; color:var(--muted); font-weight:600}
  .kpi{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .strong{color:var(--ok)}

  /* Grid containers that reflow based on layout */
  .container{display:grid; gap:12px}
  .card{background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:12px}
  .card h2{margin:0 0 6px 0; font-size:18px}
  .section-title{font-weight:700; margin:6px 0 6px}

  /* Sliders */
  .slider-row{display:grid; grid-template-columns:120px 1fr auto; gap:10px; align-items:center; margin-top:6px}
  input[type="range"]{width:100%}
  .val{min-width:56px; text-align:right; font-variant-numeric:tabular-nums}
  .time-input{display:flex; align-items:center; gap:6px}
  .choices{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
  .choices label{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:#0e1736; cursor:pointer}
  .display{font-variant-numeric:tabular-nums; font-size:48px; font-weight:800; letter-spacing:1px; margin:8px 0 8px}
  .footer{margin:12px 0; font-size:13px; color:var(--muted)}

  /* Responsive layout modes */
  body.landscape .container{grid-template-columns: 1fr 1fr}
  body.landscape .recipe-grid{grid-template-columns: 1.2fr 1fr 1fr auto}
  body.portrait .container{grid-template-columns: 1fr}
  body.portrait .recipe-grid{grid-template-columns: 1fr}

  .recipe-grid{display:grid; gap:8px}
  .recipe-grid input[type="text"], .recipe-grid select{width:100%; padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0c1430; color:var(--ink)}

  /* Totals row */
  .totals{display:flex; flex-wrap:wrap; gap:8px}
  .totals .pill{font-size:16px}

  /* Orientation hint */
  .hint{color:var(--muted); font-size:12px}
</style>
</head>
<body class="portrait">
<div class="wrap">
  <div class="title">雙計時器｜配方 + PWA + 常亮 / Dual Timers · Recipes + PWA + Wake Lock</div>
  <div class="sub">A/B 交替、臨界嗶聲、對調播報、長休息、配方、一鍵啟動；加入 **總剩餘時間**、**PWA 安裝**、**螢幕常亮**，並支援 **橫/直版切換（自動 + 手動）**。<span class="en">Alternate A/B, critical beeps, swapped speech, long rest, recipes; now with **Total Remaining Time**, **PWA install**, **Screen Wake Lock**, and **Portrait/Landscape layouts (auto + manual)**.</span></div>

  <div class="toolbar">
    <button id="startBtn" class="primary">開始循環<span class="en">Start</span></button>
    <button id="pauseBtn" disabled>暫停<span class="en">Pause</span></button>
    <button id="resetBtn" class="warn">重設<span class="en">Reset</span></button>
    <label class="pill"><input id="vibrateChk" type="checkbox"> 震動提示<span class="en">&nbsp;Vibration</span></label>
    <label class="pill"><input id="wakeChk" type="checkbox"> 螢幕常亮<span class="en">&nbsp;Keep Screen On</span></label>
    <div class="pill">
      版面：<select id="layoutSelect">
        <option value="auto">自動偵測 / Auto</option>
        <option value="portrait">直式 / Portrait</option>
        <option value="landscape">橫式 / Landscape</option>
      </select>
    </div>
    <div id="pwaStatus" class="hint">PWA：偵測中… / Checking…</div>
  </div>

  <div class="status-bar">
    <div class="big-status">
      <span>目前：<span id="who">—</span></span>
      <span class="subtxt">Now</span>
    </div>
    <span class="pill">已完成輪數：<strong id="roundsDone" class="strong">0</strong><span class="en">&nbsp;Rounds Done</span></span>
    <span class="pill">目標輪數：<strong id="roundsGoal">∞</strong><span class="en">&nbsp;Target</span></span>
  </div>

  <div class="totals">
    <span class="pill">本輪剩餘：<strong id="phaseRemain">00:00</strong><span class="en">&nbsp;This Phase Left</span></span>
    <span class="pill">總剩餘：<strong id="totalRemain">00:00</strong><span class="en">&nbsp;Total Remaining</span></span>
  </div>

  <div class="card">
    <h2>配方管理 / Recipe Manager</h2>
    <div class="recipe-grid">
      <div>
        <label>選擇配方<span class="en">Select Recipe</span></label>
        <select id="recipeSelect"></select>
      </div>
      <div>
        <label>配方名稱<span class="en">Recipe Name</span></label>
        <input id="recipeName" type="text" placeholder="例如：Archery SPT × 6 / Tabata 20/10 × 8">
      </div>
      <div style="display:flex; gap:8px; align-items:flex-end;">
        <button id="saveRecipe">儲存/覆蓋<span class="en">Save/Overwrite</span></button>
        <button id="deleteRecipe" class="warn">刪除<span class="en">Delete</span></button>
      </div>
      <div style="display:flex; gap:8px; align-items:flex-end;">
        <button id="startRecipe" class="primary">一鍵啟動當前配方<span class="en">Start Selected Recipe</span></button>
      </div>
    </div>

    <div class="section-title">輪數與長休息 / Rounds & Long Rest</div>
    <div style="display:grid; gap:10px; grid-template-columns:1fr 1fr">
      <div>
        <div class="slider-row">
          <span class="pill">本次輪數 / Rounds</span>
          <input id="roundsSlider" type="range" min="1" max="99" step="1">
          <span class="val" id="roundsVal">8</span>
        </div>
        <div class="pill" style="margin-top:6px">
          <label><input id="autoStopChk" type="checkbox" checked> 自動停止 <span class="en">&nbsp;Auto Stop</span></label>
        </div>
      </div>
      <div>
        <div class="pill" style="margin-bottom:6px">每 N 輪長休 / Long Rest every N rounds</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <span class="pill">N</span>
          <input id="longEveryN" type="number" min="0" max="999" value="0">
          <span>長休 M:SS <span class="en">Long Rest M:SS</span></span>
        </div>
        <div class="slider-row">
          <span class="pill">分鐘 / Min</span>
          <input id="longMinSlider" type="range" min="0" max="99" step="1">
          <span class="val" id="longMinVal">00</span>
        </div>
        <div class="slider-row">
          <span class="pill">秒 / Sec</span>
          <input id="longSecSlider" type="range" min="0" max="59" step="1">
          <span class="val" id="longSecVal">00</span>
        </div>
        <div class="time-input" style="margin-top:6px">
          <input id="longMin" type="number" min="0" max="99" value="00">
          <span>:</span>
          <input id="longSec" type="number" min="0" max="59" value="00">
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- A -->
    <div class="card" id="cardA">
      <h2>第一組（A） <span class="en">Timer A</span> <span class="badge" id="badgeA">待命<span class="en"> Ready</span></span></h2>
      <div class="section-title">時間（MM:SS）<span class="en">Duration (MM:SS)</span></div>
      <div class="slider-row">
        <span class="pill">分鐘 / Min</span>
        <input id="minASlider" type="range" min="0" max="99" step="1">
        <span class="val" id="minAVal">00</span>
      </div>
      <div class="slider-row">
        <span class="pill">秒 / Sec</span>
        <input id="secASlider" type="range" min="0" max="59" step="1">
        <span class="val" id="secAVal">20</span>
      </div>
      <div class="time-input"><input id="minA" type="number" min="0" max="99" value="00"><span>:</span><input id="secA" type="number" min="0" max="59" value="20"></div>

      <div class="section-title">嗶聲起點（剩餘秒）<span class="en">Beep when ≤ seconds left</span></div>
      <div class="slider-row">
        <span class="pill">嗶聲 / Beep</span>
        <input id="beepASlider" type="range" min="1" max="10" step="1">
        <span class="val"><span id="beepAVal">5</span>s</span>
      </div>
      <div class="pill" style="margin-top:6px">數字輸入 / Box <input id="beepA" type="number" min="0" max="60" value="5" style="width:64px;margin-left:8px;"></div>

      <div class="section-title">到時播報詞（在「B 組」結束時播）<span class="en">End speech (spoken when B ends)</span></div>
      <div class="choices">
        <label><input type="radio" name="wordA" value="開始" checked>開始<span class="en">Start</span></label>
        <label><input type="radio" name="wordA" value="運動">運動<span class="en">Workout</span></label>
        <label><input type="radio" name="wordA" value="發射">發射<span class="en">Launch</span></label>
        <label><input type="radio" name="wordA" value="自訂">自訂<span class="en">Custom</span></label>
      </div>
      <div class="time-input" style="margin-top:6px"><input id="customA" type="text" placeholder="自訂詞 / Custom word" style="flex:1; padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0c1430; color:var(--ink)"></div>

      <div class="display" id="dispA">00:20</div>
      <div class="pill" style="font-size:16px;">狀態：<span id="nowA" style="font-weight:700;">停止</span> <span class="en">&nbsp;Status</span></div>
    </div>

    <!-- B -->
    <div class="card" id="cardB">
      <h2>第二組（B） <span class="en">Timer B</span> <span class="badge" id="badgeB">待命<span class="en"> Ready</span></span></h2>
      <div class="section-title">時間（MM:SS）<span class="en">Duration (MM:SS)</span></div>
      <div class="slider-row">
        <span class="pill">分鐘 / Min</span>
        <input id="minBSlider" type="range" min="0" max="99" step="1">
        <span class="val" id="minBVal">00</span>
      </div>
      <div class="slider-row">
        <span class="pill">秒 / Sec</span>
        <input id="secBSlider" type="range" min="0" max="59" step="1">
        <span class="val" id="secBVal">10</span>
      </div>
      <div class="time-input"><input id="minB" type="number" min="0" max="99" value="00"><span>:</span><input id="secB" type="number" min="0" max="59" value="10"></div>

      <div class="section-title">嗶聲起點（剩餘秒）<span class="en">Beep when ≤ seconds left</span></div>
      <div class="slider-row">
        <span class="pill">嗶聲 / Beep</span>
        <input id="beepBSlider" type="range" min="1" max="10" step="1">
        <span class="val"><span id="beepBVal">5</span>s</span>
      </div>
      <div class="pill" style="margin-top:6px">數字輸入 / Box <input id="beepB" type="number" min="0" max="60" value="5" style="width:64px;margin-left:8px;"></div>

      <div class="section-title">到時播報詞（在「A 組」結束時播）<span class="en">End speech (spoken when A ends)</span></div>
      <div class="choices">
        <label><input type="radio" name="wordB" value="休息" checked>休息<span class="en">Rest</span></label>
        <label><input type="radio" name="wordB" value="暫停">暫停<span class="en">Pause</span></label>
        <label><input type="radio" name="wordB" value="恢復">恢復<span class="en">Recover</span></label>
        <label><input type="radio" name="wordB" value="自訂">自訂<span class="en">Custom</span></label>
      </div>
      <div class="time-input" style="margin-top:6px"><input id="customB" type="text" placeholder="自訂詞 / Custom word" style="flex:1; padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0c1430; color:var(--ink)"></div>

      <div class="display" id="dispB">00:10</div>
      <div class="pill" style="font-size:16px;">狀態：<span id="nowB" style="font-weight:700;">停止</span> <span class="en">&nbsp;Status</span></div>
    </div>
  </div>

  <div class="footer">
    聲音/語音需先有一次按鈕互動；高精度計時避免飄移；螢幕常亮需支援 Wake Lock API；PWA 需要 HTTPS 服務環境。<span class="en">Audio/Speech require first user interaction. High-precision timing. Wake Lock requires API support. PWA needs HTTPS hosting.</span>
  </div>
</div>

<script>
(() => {
  // ==== Utils ====
  const clamp=(v,min,max)=>Math.max(min,Math.min(max, v|0));
  const pad2=n=>String(n).padStart(2,'0');
  const el=id=>document.getElementById(id);
  const save=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
  const load=(k,def)=>{ try{ const x=JSON.parse(localStorage.getItem(k)); return x ?? def; }catch{ return def; } };
  const fmt=(secs)=>{ secs=Math.max(0,secs|0); const m=Math.floor(secs/60), s=secs%60; return pad2(m)+':'+pad2(s); };

  // ==== Audio ====
  let audioCtx=null,lastBeepAt=0;
  function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
  function beep(){
    if(!audioCtx) return;
    const now=performance.now(); if(now-lastBeepAt<120) return; lastBeepAt=now;
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='square'; o.frequency.value=1000; g.gain.value=0.0001; o.connect(g).connect(audioCtx.destination);
    const t=audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(0.25,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.18);
    o.start(t); o.stop(t+0.2);
  }
  function speak(text){ if(!text) return; const u=new SpeechSynthesisUtterance(text); u.lang='zh-TW'; u.rate=1.0; u.pitch=1.0; speechSynthesis.cancel(); speechSynthesis.speak(u); }
  function vib(p){ if(!el('vibrateChk').checked) return; if(navigator.vibrate) navigator.vibrate(p); }

  // ==== Wake Lock ====
  let wakeLock=null;
  async function requestWake(){
    if(!('wakeLock' in navigator)) return false;
    try{
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener?.('release', ()=>{ /* auto released */ });
      return true;
    }catch(e){ return false; }
  }
  async function releaseWake(){ try{ await wakeLock?.release(); }catch{} finally{ wakeLock=null; } }
  el('wakeChk').addEventListener('change', async ()=>{
    if(el('wakeChk').checked){ const ok=await requestWake(); if(!ok){ el('wakeChk').checked=false; alert('此裝置/瀏覽器不支援螢幕常亮 Wake Lock。'); } }
    else { await releaseWake(); }
  });
  document.addEventListener('visibilitychange', async ()=>{ // re-acquire on visibility return
    if(document.visibilityState==='visible' && el('wakeChk').checked){ await requestWake(); }
  });

  // ==== DOM refs ====
  const minA=el('minA'), secA=el('secA'), dispA=el('dispA'), nowA=el('nowA'), beepA=el('beepA'), badgeA=el('badgeA');
  const minB=el('minB'), secB=el('secB'), dispB=el('dispB'), nowB=el('nowB'), beepB=el('beepB'), badgeB=el('badgeB');
  const customA=el('customA'), customB=el('customB');
  const startBtn=el('startBtn'), pauseBtn=el('pauseBtn'), resetBtn=el('resetBtn'), who=el('who');
  const roundsDoneEl=el('roundsDone'), roundsGoalEl=el('roundsGoal');
  const phaseRemainEl=el('phaseRemain'), totalRemainEl=el('totalRemain');

  const roundsSlider=el('roundsSlider'), roundsVal=el('roundsVal'), autoStopChk=el('autoStopChk');
  const longEveryN=el('longEveryN'), longMin=el('longMin'), longSec=el('longSec');
  const minASlider=el('minASlider'), secASlider=el('secASlider'), minAVal=el('minAVal'), secAVal=el('secAVal');
  const minBSlider=el('minBSlider'), secBSlider=el('secBSlider'), minBVal=el('minBVal'), secBVal=el('secBVal');
  const beepASlider=el('beepASlider'), beepAVal=el('beepAVal');
  const beepBSlider=el('beepBSlider'), beepBVal=el('beepBVal');
  const longMinSlider=el('longMinSlider'), longSecSlider=el('longSecSlider'), longMinVal=el('longMinVal'), longSecVal=el('longSecVal');

  const recipeSelect=el('recipeSelect'), recipeName=el('recipeName');
  const saveRecipeBtn=el('saveRecipe'), delRecipeBtn=el('deleteRecipe'), startRecipeBtn=el('startRecipe');

  // ==== Words ====
  function selectedWord(group){
    const name=group==='A'?'wordA':'wordB';
    const val=(document.querySelector(`input[name="${name}"]:checked`)||{}).value;
    if(val==='自訂') return (group==='A'?customA.value:customB.value)||'完成';
    return val||'完成';
  }

  // ==== Values ====
  const fix2=inp=>{ inp.addEventListener('change',()=>{ let v=clamp(inp.value, +inp.min, +inp.max); inp.value=pad2(v); saveAll(); updateDisplays(); }); };
  [minA,secA,minB,secB,longMin,longSec].forEach(fix2);
  [minA,secA,minB,secB,beepA,beepB,customA,customB,longEveryN,longMin,longSec].forEach(e=>e.addEventListener('input', ()=>{ saveAll(); updateDisplays(); }));
  document.querySelectorAll('input[name="wordA"],input[name="wordB"]').forEach(r=>r.addEventListener('change', saveAll));
  autoStopChk.addEventListener('change', ()=>{ saveAll(); syncGoal(); });

  function bindPair(numEl, sliderEl, valEl, pad=true){
    const syncFromNum=()=>{ const v=clamp(numEl.value, +numEl.min, +numEl.max); sliderEl.value=v; if(valEl) valEl.textContent=pad?pad2(v):v; saveAll(); updateDisplays(); };
    const syncFromSlider=()=>{ const v=+sliderEl.value; numEl.value=pad?pad2(v):v; if(valEl) valEl.textContent=pad?pad2(v):v; saveAll(); updateDisplays(); };
    numEl.addEventListener('input', syncFromNum);
    sliderEl.addEventListener('input', syncFromSlider);
    sliderEl.value=clamp(numEl.value, +sliderEl.min, +sliderEl.max);
    if(valEl) valEl.textContent=pad?pad2(sliderEl.value):sliderEl.value;
  }
  bindPair(minA, minASlider, minAVal, true);
  bindPair(secA, secASlider, secAVal, false);
  bindPair(minB, minBSlider, minBVal, true);
  bindPair(secB, secBSlider, secBVal, false);
  function bindBeep(numEl, sliderEl, valEl){
    const syncFromNum=()=>{ let v=clamp(numEl.value, 0, 60); numEl.value=v; if(v!==0 && v<1){ v=1; numEl.value=1; }
      sliderEl.value=clamp(v||1, +sliderEl.min, +sliderEl.max); valEl.textContent=sliderEl.value; saveAll(); };
    const syncFromSlider=()=>{ const v=+sliderEl.value; numEl.value=v; valEl.textContent=v; saveAll(); };
    numEl.addEventListener('input', syncFromNum); sliderEl.addEventListener('input', syncFromSlider);
    sliderEl.value=clamp(numEl.value||5, +sliderEl.min, +sliderEl.max); valEl.textContent=sliderEl.value;
  }
  bindBeep(beepA, beepASlider, beepAVal);
  bindBeep(beepB, beepBSlider, beepBVal);
  function bindRounds(){
    const syncFromNum=()=>{ let v=clamp(roundsSlider.value,1,99); roundsVal.textContent=v; saveAll(); syncGoal(); };
    roundsSlider.addEventListener('input', syncFromNum);
    roundsSlider.value=8; roundsVal.textContent='8';
  }
  bindRounds();
  function bindLongSliders(){
    const syncMin=()=>{ longMin.value=pad2(clamp(longMinSlider.value,0,99)); longMinVal.textContent=pad2(longMinSlider.value); saveAll(); updateDisplays(); };
    const syncSec=()=>{ longSec.value=pad2(clamp(longSecSlider.value,0,59)); longSecVal.textContent=pad2(longSecSlider.value); saveAll(); updateDisplays(); };
    longMinSlider.addEventListener('input', syncMin);
    longSecSlider.addEventListener('input', syncSec);
    longMinSlider.value=0; longSecSlider.value=0; longMinVal.textContent='00'; longSecVal.textContent='00';
  }
  bindLongSliders();

  // ==== Timer state ====
  let timer={ current:null, running:false, endTs:0, remainMs:0, rafId:null, lastWhole:null, roundsDone:0, roundsGoal:Infinity, longEvery:0 };
  function otherGroup(g){ return g==='A'?'B':'A'; }

  function totalSecsOf(group){
    if(group==='A') return clamp(minA.value,0,99)*60 + clamp(secA.value,0,59);
    if(group==='B') return clamp(minB.value,0,99)*60 + clamp(secB.value,0,59);
    if(group==='LONG') return clamp(longMin.value,0,99)*60 + clamp(longSec.value,0,59);
    return 0;
  }
  function beepStart(g){ return clamp(g==='A'?beepA.value:beepB.value,0,60); }
  function setDisplay(g, secs){ (g==='A'?dispA:dispB).textContent = fmt(secs); }
  function setState(g, text, active=false){
    (g==='A'?nowA:nowB).textContent = text.replace(' / ','');
    (g==='A'?badgeA:badgeB).textContent = active ? '計時中 / Running' : (text.includes('停止')?'待命 / Ready':text);
  }
  function syncGoal(){ timer.roundsGoal = el('autoStopChk').checked ? (+roundsSlider.value|0) : Infinity;
    roundsGoalEl.textContent = isFinite(timer.roundsGoal) ? timer.roundsGoal : '∞'; }

  function startCycle(){ ensureAudio(); syncGoal(); if(timer.running) return;
    timer.roundsDone=0; roundsDoneEl.textContent='0'; timer.longEvery=clamp(longEveryN.value,0,999);
    timer.current='A'; who.textContent='A 組 / Timer A'; setState('A','啟動 / Start',true);
